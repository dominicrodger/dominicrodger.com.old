<!DOCTYPE html>
<html lang="en">
<head>
        <title>Avoiding database queries with Haystack</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
        <link href="http://dominicrodger.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="dominicrodger.com Atom Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

<a href="https://github.com/dominicrodger/dominicrodger.com">

<img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" />

</a>

        <header id="banner" class="body">
                <h1><a href=".">dominicrodger.com </a></h1>
                <nav><ul>
                
                
                
                    <li><a href="./pages/about-me.html">about me</a></li>
                
                
                
                    <li class="active"><a href="./category/code.html">code</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Avoiding database queries with Haystack">Avoiding database queries with Haystack</a></h1> 
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="dominicrodger">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
 </header>
        <div class="entry-content">
        <footer class="post-info">
        <abbr class="published" title="2012-07-05T17:20:00">
                Thursday 05 July 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="./author/dominic-rodger.html">Dominic Rodger</a>
        </address>
        
<p>In <a href="./category/code.html">code</a>. </p>



</footer><!-- /.post-info -->
        <h1>Order(n) is a pretty bad idea.</h1>
<p>Originally, my SearchIndexes for <a href="http://haystacksearch.org/" title="Haystack is a search solution for Django apps">Haystack</a> looked a bit
like this:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">RegularEventIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Then, when someone ran a search, and I wanted to display a result, I'd
load up a template (which template I loaded depended on grabbing the
model name, as recommended in <a href="http://django-haystack.readthedocs.org/en/v1.2.7/best_practices.html#content-type-specific-templates" title="Use a filter to generate the template name for your search results.">the docs</a>), and any
attributes of the model I wanted to display required doing a database
lookup to fetch the data, like this:</p>
<div class="codehilite"><pre><span class="nt">&lt;h2&gt;</span>{{ result.object.title }}<span class="nt">&lt;/h2&gt;</span>
{{ result.object.details|linebreaks }}
</pre></div>


<p>This has a fairly obvious problem - each time you display a search
result, you do a database query.</p>
<h1>Better - avoiding database lookups</h1>
<p>I tried avoiding that problem like this:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">RegularEventIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">model_attr</span><span class="o">=</span><span class="s">&#39;modified&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">model_attr</span><span class="o">=</span><span class="s">&#39;title&#39;</span><span class="p">)</span>
    <span class="n">details</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">model_attr</span><span class="o">=</span><span class="s">&#39;details&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>Which meant writing templates like this<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>
<div class="codehilite"><pre><span class="nt">&lt;h2&gt;</span>{{ result.title|safe }}<span class="nt">&lt;/h2&gt;</span>
{{ result.details|safe|linebreaks }}
</pre></div>


<p>The downside of this was that any attributes of the model I wanted to
display had to be hooked up in the <code>SearchIndex</code>. This was made worse
by the fact that you had to remember to keep whether or not a
particular field could be null in sync between the model and the
<code>SearchIndex</code> (spot the <code>null=True</code> in the <code>details</code> attribute above).</p>
<h1>Betterer - pre-render search result templates</h1>
<p>At the point when the index is built, templates have access to the
model instance. This doesn't involve any extra queries (we already had
to load the instance to generate the index for it), and is done once
per object change (instead of once per inclusion in search results),
which is probably a win for most sites.</p>
<p>So, I added a field to my <code>SearchIndex</code> that looked like this:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">RegularEventIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">model_attr</span><span class="o">=</span><span class="s">&#39;modified&#39;</span><span class="p">)</span>
    <span class="n">rendered</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>


<p>I then moved my template that was previously used to render search
results on the fly, to the location used by Haystack to look for
search templates
(<code>search/indexes/kanisa/&lt;object_name&gt;_rendered.txt</code>). In that template
I have full access to the model (i.e. I can call methods on it, which
wasn't possible without a database query before).</p>
<p>My new template looks like this<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>:</p>
<div class="codehilite"><pre><span class="nt">&lt;h2&gt;</span>{{ object.title }}<span class="nt">&lt;/h2&gt;</span>
{{ object.details|linebreaks }}
</pre></div>


<h1>Best - do all this stuff in a base class</h1>
<p>Once I'd added my new <code>rendered</code> attribute to my various
SearchIndexes, I realised that all my SearchIndexes were more or less
the same. I no longer needed all the attributes on them which I had
before (since they were only there to avoid database lookups when
generating templates on the fly), so I could now just have a base
<code>SearchIndex</code>, which would be fine for most my models<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>
<p>It looks like this:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">KanisaBaseSearchIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">rendered</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">use_template</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">model_attr</span><span class="o">=</span><span class="s">&#39;title&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_updated_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;modified&#39;</span>
</pre></div>


<p>Almost all my models can use this as is, which makes adding new models
to my site search just a case of registering them in
<code>search_indexes.py</code> and adding two templates (<code>&lt;object_name&gt;_text.txt</code>
for the searchable content, and <code>&lt;object_name&gt;_rendered.txt</code> for the
displayable search result).</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>This took me a while to figure out, but attributes going in to
  Haystack have already been escaped once, so need to be marked as
  <code>safe</code>.&#160;<a href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>This is the same as the template above, I've just replaced
  <code>result.object</code> with <code>object</code>.&#160;<a href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>A couple of them have custom titles, which is an attribute I
  access directly on search results.&#160;<a href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
        </div><!-- /.entry-content -->
        

</article>
</section>

        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://dominicrodger.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/dominicrodger">Twitter</a></li>
                        
                            <li><a href="http://github.com/dominicrodger">GitHub</a></li>
                        
                            <li><a href="http://stackoverflow.com/users/20972/dominic-rodger">Stack Overflow</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://pelican.notmyidea.org/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                Site hosted by <a href="http://www.webfaction.com?affiliate=dominicrodger" title="Get hosted by WebFaction">WebFaction</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->


    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-11204085-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>



</body>
</html>